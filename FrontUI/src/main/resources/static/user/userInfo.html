<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>회원정보 보기</title>
    <link rel="stylesheet" href="/css/table.css"/>
    <script type="text/javascript" src="/js/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="/js/common.js"></script>
    <script>
        "use strict";

        $(function () {
            // 보호 페이지: 로그인 필수
            requireLogin({
                redirect: false, // 직접 next 파라미터를 붙여 이동
                onAuthed: function (user) {
                    // 인증 성공 → 사용자 정보 로드
                    bindHandlers();
                    loadUserInfo();
                },
                onUnauthed: function () {
                    // 미인증 → 로그인 페이지로(next에 현재 페이지 경로 유지)
                    goLoginWithNext();
                }
            });
        });

        /** 현재 페이지를 next로 달아서 로그인 페이지로 이동 */
        function goLoginWithNext() {
            const next = encodeURIComponent(location.pathname + location.search);
            location.href = loginPage + "?next=" + next;
        }

        /** 버튼 등 이벤트 바인딩 */
        function bindHandlers() {
            $("#btnLogout").on("click", function () {
                // 공통 apiUrl 사용: 프로토콜/호스트 일관성 유지
                location.href = apiUrl("/user/v1/logout");
            });
        }

        /** 회원정보 조회 */
        function loadUserInfo() {
            $.ajax({
                url: apiUrl("/user/v1/userInfo"),
                type: "POST",
                // ajaxSetup에 의해 contentType/dataType/xhrFields 이미 세팅됨
                data: JSON.stringify({}) // 서버가 JSON 바디를 기대하지 않아도 빈 객체는 안전
            })
                .done(function (res) {
                    // 표준({status, message, data}) 또는 평면형 모두 대응
                    const u = (res && res.data) ? res.data : (res || {});
                    // 안전 출력(XSS 방지 및 중복 렌더 방지 위해 text 사용)
                    $("#userId").text(u.userId || "");
                    $("#userName").text(u.userName || "");
                    $("#email").text(u.email || "");
                    $("#addr1").text(u.addr1 || "");
                    $("#addr2").text(u.addr2 || "");
                })
                .fail(function (xhr) {
                    // 에러 메시지 안내 후 로그인 화면으로
                    alert(extractErrorMessageFromXhr(xhr));
                    goLoginWithNext();
                });
        }
    </script>
</head>
<body>
<h2>회원정보 상세 보기</h2>
<hr/>
<br/>
<div class="divTable minimalistBlack">
    <div class="divTableBody">
        <div class="divTableRow">
            <div class="divTableCell">아이디</div>
            <div class="divTableCell" id="userId"></div>
        </div>
        <div class="divTableRow">
            <div class="divTableCell">이름</div>
            <div class="divTableCell" id="userName"></div>
        </div>
        <div class="divTableRow">
            <div class="divTableCell">이메일</div>
            <div class="divTableCell" id="email"></div>
        </div>
        <div class="divTableRow">
            <div class="divTableCell">주소</div>
            <div class="divTableCell" id="addr1"></div>
        </div>
        <div class="divTableRow">
            <div class="divTableCell">상세 주소</div>
            <div class="divTableCell" id="addr2"></div>
        </div>
    </div>
</div>
<br/>
<div>
    <button id="btnLogout" type="button">로그아웃</button>
</div>
</body>
</html>