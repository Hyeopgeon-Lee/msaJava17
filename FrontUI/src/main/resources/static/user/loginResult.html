<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>로그인 성공!</title>
    <link rel="stylesheet" href="/css/table.css"/>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/common.js"></script>
    <script>
        "use strict";

        $(function () {
            // requireLogin은 현재 common.js에서 '미인증 성공 콜백만 호출'하고
            // 자동 리다이렉트는 주석 처리되어 있음.
            // => 여기서 직접 로그인 페이지로 보냄(원복 경로를 next로 달아주기)
            requireLogin({
                onAuthed: function (user) {
                    const uid = user?.userId || user?.username || "";
                    $("#loginUserId").text(uid ? (uid + "님이 로그인했습니다.") : "로그인되었습니다.");
                    loadUserInfo();
                },
                onUnauthed: function () {
                    // 로그인 안 된 경우 직접 이동
                    const next = encodeURIComponent("/user/loginResult.html");
                    location.href = loginPage + "?next=" + next;
                }
            });

            $("#btnBack").on("click", function () {
                location.href = "/";
            });
        });

        function loadUserInfo() {
            $.ajax({
                url: apiUrl("/user/v1/userInfo"),
                type: "POST",
                // 전역 ajaxSetup에 의해 contentType/dataType/withCredentials 이미 설정됨
                // 서버가 JSON 바디를 기대하지 않아도 빈 객체는 안전합니다.
                data: JSON.stringify({})
            })
                .done(function (res) {
                    // {status,message,data:{...}} or 평면형 모두 대응
                    const u = (res && res.data) ? res.data : (res || {});
                    $("#userId").text(u.userId ?? "");
                    $("#userName").text(u.userName ?? "");
                })
                .fail(function (xhr) {
                    alert(extractErrorMessageFromXhr(xhr));
                    // 토큰 만료 등인 경우 로그인 화면으로
                    const next = encodeURIComponent("/user/loginResult.html");
                    location.href = loginPage + "?next=" + next;
                });
        }
    </script>
</head>
<body>
<h2>로그인 성공!</h2>
<div style="margin: 6px 0; color: #555">
    <span id="loginUserId"></span>
</div>
<hr/>
<br/>

<div class="divTable minimalistBlack">
    <div class="divTableBody">
        <div class="divTableRow">
            <div class="divTableCell">아이디</div>
            <div class="divTableCell" id="userId"></div>
        </div>
        <div class="divTableRow">
            <div class="divTableCell">이름</div>
            <div class="divTableCell" id="userName"></div>
        </div>
    </div>
</div>

<br/>
<div>
    <button id="btnBack" type="button">메인으로</button>
</div>
</body>
</html>
