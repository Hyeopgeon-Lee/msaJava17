<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>게시판 글보기</title>
    <link rel="stylesheet" href="/css/table.css"/>
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="/js/common.js"></script>
    <script type="text/javascript">
        "use strict";

        const param = new URLSearchParams(window.location.search);
        const nSeq = param.get("nSeq");

        // 로그인 사용자 / 게시글 작성자
        let loginUser = null;      // { userId, ... } 또는 null
        let authorUserId = "";     // 게시글 작성자 아이디

        $(function () {
            // 기본: 버튼은 숨김 후 시작
            $("#btnEdit, #btnDelete").hide();

            // 비동기 2건(로그인 상태, 글 상세) 병렬 조회 후 버튼 토글
            $.when(loadLoginInfoSilently(), getNoticeInfo()).always(function () {
                toggleAuthorButtons();
            });

            bindHandlers();
        });


        // 버튼 토글 (로그인 사용자와 작성자가 동일할 때만 노출)
        function toggleAuthorButtons() {
            const currentUserId = loginUser && loginUser.userId;
            const isAuthor = !!currentUserId && currentUserId === authorUserId;

            if (isAuthor) {
                $("#btnEdit, #btnDelete").show();
            } else {
                $("#btnEdit, #btnDelete").hide();
            }
        }

        // 공지사항 상세 조회
        function getNoticeInfo() {
            return $.ajax({
                url: apiUrl("/notice/v1/noticeInfo"),
                type: "POST",
                data: JSON.stringify({noticeSeq: nSeq, readCntYn: "Y"})
            }).done(function (json) {
                // 응답 포맷: { status, message, data } 또는 필드 평면형
                const r = (json && json.data) ? json.data : json;

                authorUserId = r.userId || "";
                $("#title").text(r.title ?? "");
                $("#regDt").text(r.regDt ?? "");
                $("#readCnt").text(r.readCnt ?? "");
                $("#contents").html(r.contents ?? "");

                // 공지글 여부 라디오 반영(보기 용도)
                $(":radio[name='noticeYn'][value='" + (r.noticeYn || "N") + "']").prop("checked", true);

                // 작성자 정보를 알게 되었으니 버튼 토글 시도
                toggleAuthorButtons();
            }).fail(function (jqXHR) {
                alert(extractErrorMessageFromXhr(jqXHR));

            });
        }

        // 로그인 정보 조회 (리디렉션 없음)
        function loadLoginInfoSilently() {
            return fetchLoginInfo()
                .done(function (res) {
                    const data = res && res.data;
                    const authed = data.userId;
                    loginUser = authed ? data : null;
                })
                .fail(function () {
                    loginUser = null;
                })
                .always(function () {
                    toggleAuthorButtons();
                });
        }

        // 이벤트 핸들러
        function bindHandlers() {
            $("#btnEdit").on("click", function () {
                const currentUserId = loginUser.userId;
                if (currentUserId === authorUserId) {
                    location.href = "/notice/noticeEditInfo.html?nSeq=" + nSeq;
                } else {
                    alert("본인이 작성한 글만 수정 가능합니다.");
                }
            });

            $("#btnDelete").on("click", function () {
                const currentUserId = loginUser.userId;
                if (currentUserId !== authorUserId) {
                    alert("본인이 작성한 글만 삭제 가능합니다.");
                    return;
                }
                if (!confirm("작성한 글을 삭제하시겠습니까?")) {
                    return;
                }

                $.ajax({
                    url: apiUrl("/notice/v1/noticeDelete"),
                    type: "POST",
                    data: JSON.stringify({noticeSeq: nSeq})
                }).done(function (json) {
                    const r = json || {};
                    const msg = (r.data && r.data.msg) || r.message || "삭제되었습니다.";
                    alert(msg);
                    location.href = "/notice/noticeList.html";
                }).fail(function (jqXHR) {
                    alert(extractErrorMessageFromXhr(jqXHR));

                    if (jqXHR.status === 401) {
                        location.href = loginPage;
                    }
                });
            });

            $("#btnList").on("click", function () {
                location.href = "/notice/noticeList.html";
            });
        }
    </script>
</head>
<body>
<h2>공지사항 상세보기</h2>
<hr/>
<br/>
<div class="divTable minimalistBlack">
    <div class="divTableBody">
        <div class="divTableRow">
            <div class="divTableCell">제목</div>
            <div class="divTableCell" id="title"></div>
        </div>
        <div class="divTableRow">
            <div class="divTableCell">공지글 여부</div>
            <div class="divTableCell">
                예 <input type="radio" name="noticeYn" value="Y" disabled/>
                아니오 <input type="radio" name="noticeYn" value="N" disabled/>
            </div>
        </div>
        <div class="divTableRow">
            <div class="divTableCell">작성일</div>
            <div class="divTableCell" id="regDt"></div>
        </div>
        <div class="divTableRow">
            <div class="divTableCell">조회수</div>
            <div class="divTableCell" id="readCnt"></div>
        </div>
        <div class="divTableRow">
            <div class="divTableCell">내용</div>
            <div class="divTableCell" id="contents"></div>
        </div>
    </div>
</div>

<div>
    <button id="btnEdit" type="button" style="display:none">수정</button>
    <button id="btnDelete" type="button" style="display:none">삭제</button>
    <button id="btnList" type="button">목록</button>
</div>
</body>
</html>
