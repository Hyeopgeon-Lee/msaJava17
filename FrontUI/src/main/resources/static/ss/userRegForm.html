<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>회원가입 화면</title>
    <link rel="stylesheet" href="/css/table.css"/>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script type="text/javascript" src="/js/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="/js/jquery.serializeObject.min.js"></script>
    <script type="text/javascript" src="/js/common.js"></script>
    <style>
        .btn--loading {
            opacity: .6;
            pointer-events: none;
        }
    </style>
    <script>
        "use strict";

        $(function () {
            const f = document.getElementById("f");

            // Enter 키로 제출 지원
            $("#f").on("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    $("#btnSend").click();
                }
            });

            // 회원가입 버튼
            $("#btnSend").on("click", function () {
                doSubmit(f);
            });

            // 카카오 주소 찾기 버튼
            $("#btnAddr").on("click", function () {
                kakaoPost(f);
            });
        });

        // 포커스 + 경고 헬퍼
        function warn(inputEl, message) {
            alert(message);
            inputEl.focus();
            return false;
        }

        // 회원가입 유효성 검사 + 제출
        function doSubmit(f) {
            // 간단한 필수값 체크
            if (!f.userId.value.trim()) return warn(f.userId, "아이디를 입력하세요.");
            if (!f.userName.value.trim()) return warn(f.userName, "이름을 입력하세요.");
            if (!f.password.value) return warn(f.password, "비밀번호를 입력하세요.");
            if (!f.password2.value) return warn(f.password2, "비밀번호확인을 입력하세요.");
            if (f.password.value !== f.password2.value) return warn(f.password2, "비밀번호와 비밀번호 확인이 일치하지 않습니다.");
            if (!f.email.value.trim()) return warn(f.email, "이메일을 입력하세요.");
            if (!f.addr1.value.trim()) return warn(f.addr1, "주소를 입력하세요.");
            if (!f.addr2.value.trim()) return warn(f.addr2, "상세주소를 입력하세요.");

            // (선택) 아주 기본적인 이메일 형식 점검
            // const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.email.value.trim());
            // if (!emailOk) return warn(f.email, "이메일 형식을 확인하세요.");

            // 중복 제출 방지
            const $btn = $("#btnSend");
            if ($btn.hasClass("btn--loading")) return;
            $btn.addClass("btn--loading").val("처리 중...");

            $.ajax({
                url: apiUrl("/reg/v1/insertUserInfo"),
                type: "POST",
                data: JSON.stringify($("#f").serializeObject())
                // contentType/dataType/xhrFields는 common.js의 $.ajaxSetup 적용됨
            })
                .done(function (json) {
                    // 표준 응답 해석
                    const ok = json?.status === 200 && json?.data?.result === 1;
                    const msg = json?.data?.msg || json?.message || "처리되었습니다.";
                    alert(msg);
                    if (ok) {
                        // 가입 성공 → 로그인 화면으로
                        location.href = "/ss/login.html";
                    }
                })
                .fail(function (jqXHR) {
                    alert(extractErrorMessageFromXhr(jqXHR));
                })
                .always(function () {
                    $btn.removeClass("btn--loading").val("회원가입");
                });
        }

        // 카카오 우편번호
        function kakaoPost(f) {
            new daum.Postcode({
                oncomplete: function (data) {
                    const address = data.address || "";
                    const zonecode = data.zonecode || "";
                    f.addr1.value = (zonecode ? "(" + zonecode + ") " : "") + address;
                    f.addr2.focus();
                }
            }).open();
        }
    </script>
</head>
<body>
<h2>회원 가입하기</h2>
<hr/>
<br/>
<form id="f">
    <div class="divTable minimalistBlack">
        <div class="divTableBody">
            <div class="divTableRow">
                <div class="divTableCell">* 아이디
                </div>
                <div class="divTableCell">
                    <input type="text" name="userId" style="width:95%"/>
                </div>
            </div>
            <div class="divTableRow">
                <div class="divTableCell">* 이름
                </div>
                <div class="divTableCell">
                    <input type="text" name="userName" style="width:95%"/>
                </div>
            </div>
            <div class="divTableRow">
                <div class="divTableCell">* 비밀번호
                </div>
                <div class="divTableCell">
                    <input type="password" name="password" style="width:95%"/>
                </div>
            </div>
            <div class="divTableRow">
                <div class="divTableCell">* 비밀번호확인
                </div>
                <div class="divTableCell">
                    <input type="password" name="password2" style="width:95%"/>
                </div>
            </div>
            <div class="divTableRow">
                <div class="divTableCell">* 이메일
                </div>
                <div class="divTableCell">
                    <input type="email" name="email" style="width:95%"/>
                </div>
            </div>
            <div class="divTableRow">
                <div class="divTableCell">* 주소
                </div>
                <div class="divTableCell">
                    <input type="text" name="addr1" style="width:85%"/>
                    <input type="button" id="btnAddr" value="우편번호"/>
                </div>
            </div>
            <div class="divTableRow">
                <div class="divTableCell">* 상세 주소
                </div>
                <div class="divTableCell">
                    <input type="text" name="addr2" style="width:95%"/>
                </div>
            </div>
        </div>
    </div>
    <div>
        <input type="button" id="btnSend" value="회원가입"/>
    </div>
</form>
</body>
</html>