<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="strict-origin-when-cross-origin"/>
    <title>로그인 화면</title>
    <link rel="stylesheet" href="/css/table.css"/>
    <script type="text/javascript" src="/js/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="/js/jquery.serializeObject.min.js"></script>
    <script type="text/javascript" src="/js/common.js"></script>
    <style>
        .btn--loading {
            opacity: .6;
            pointer-events: none;
        }
    </style>
    <script>
        "use strict";

        $(function () {
            const params = new URLSearchParams(location.search);
            const next = params.get("next") || "/user/loginResult.html";

            $("#btnUserReg").on("click", () => location.href = "/ss/userRegForm.html");
            $("#btnMain").on("click", () => location.href = "/index.html");

            // Enter 제출 지원
            $("#f").on("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    $("#btnLogin").click();
                }
            });

            let submitting = false;

            $("#btnLogin").on("click", function () {
                if (submitting) return;

                const f = document.getElementById("f");
                const userId = f.userId.value.trim();
                const password = f.password.value;

                if (!userId) {
                    alert("아이디를 입력하세요.");
                    f.userId.focus();
                    return;
                }
                if (!password) {
                    alert("비밀번호를 입력하세요.");
                    f.password.focus();
                    return;
                }

                // 버튼 상태 잠금
                submitting = true;
                const $btn = $("#btnLogin").addClass("btn--loading");
                const prevText = $btn.text();
                $btn.text("로그인 중...");

                $.ajax({
                    url: apiUrl("/login/v1/loginProc"),
                    method: "POST",
                    data: JSON.stringify({userId, password})

                }).done(function (res) {
                    // 표준 포맷: {status,message,data:{result,msg,...}}
                    const ok = res && res.data && res.data.result === 1;
                    const msg = (res && res.data && res.data.msg) || res?.message;

                    if (ok) {
                        if (msg) alert(msg);
                        // next 파라미터가 있으면 해당 경로로
                        location.href = next;
                    } else {
                        alert(msg || "로그인에 실패했습니다.");
                        f.userId.focus();
                    }

                }).fail(function (jqXHR) {
                    alert(extractErrorMessageFromXhr(jqXHR));
                    f.userId.focus();

                }).always(function () {
                    submitting = false;
                    $btn.removeClass("btn--loading").text(prevText);
                });
            });
        });
    </script>

</head>
<body>
<h2>로그인하기</h2>
<hr/>
<br/>
<form id="f">
    <div class="divTable minimalistBlack">
        <div class="divTableBody">
            <div class="divTableRow">
                <div class="divTableCell">아이디
                </div>
                <div class="divTableCell">
                    <input type="text" name="userId" id="userId" style="width:95%"/>
                </div>
            </div>
            <div class="divTableRow">
                <div class="divTableCell">비밀번호
                </div>
                <div class="divTableCell">
                    <input type="password" name="password" id="password" style="width:95%"/>
                </div>
            </div>
        </div>
    </div>
    <div>
        <button id="btnLogin" type="button">로그인</button>
        <button id="btnUserReg" type="button">회원가입</button>
        <button id="btnMain" type="button">메인화면</button>
    </div>
</form>
</body>
</html>